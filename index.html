<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .axis path,
        .axis line {
            fill: none;
            stroke: var(--var-color-grey);
            shape-rendering: crispEdges;
        }
        .x.axis {font-size: 10px;  }
        .y.axis {font-size: 12px; }
    </style>

</head>
<body>
    <div class="container">
        <div class="row">
            <h5 class="center-align">Singapore Crime Analysis</h5>
        </div>
        <div class="row">
            <div class="col s12" id="charts">
                
            </div>    
        </div>
    </div>
</body>

    <script>
        var settings = {
            "async": true,
            "crossDomain": true,
            "url": "https://data.gov.sg/api/action/datastore_search?resource_id=83c21090-bd19-4b54-ab6b-d999c251edcf&q=2020",
            "method": "GET"
        }

        $.ajax(settings).done(function (response) {
            let dataset = response['result']['records']
            total = 0
            for(let i = 0; i<dataset.length; i++){
                total += parseInt(dataset[i]['value'])
            }
            for(let i = 0; i<dataset.length; i++){
                dataset[i]['value'] = parseInt(dataset[i]['value'])/total
            }
            console.log(dataset)

            let margin = {top: 20, right: 20, bottom: 40, left: 40},
            width = 1000 - margin.left - margin.right,
            height = 600 - margin.top - margin.bottom;
            
            var greyColor = "#898989";
            var barColor = d3.interpolateInferno(0.4);
            var highlightColor = d3.interpolateInferno(0.3);

            var formatPercent = d3.format(".0%");

            var svg = d3.select("#charts")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.4);
            var y = d3.scaleLinear()
                .range([height, 0]);

            var xAxis = d3.axisBottom(x).tickSize([]).tickPadding(10);
            var yAxis = d3.axisLeft(y).tickFormat(formatPercent)

            x.domain(dataset.map( d => { return d.level_2; }));
            // y.domain([0, d3.max(dataset,  d => { return d.value; })]);
            y.domain([0, 1]);
            
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);
            svg.append("g")
                .attr("class","y axis")
                .call(yAxis);

            svg.selectAll(".bar")
                .data(dataset)
                .enter().append("rect")
                .attr("class", "bar")
                .style("display", d => { return d.value === null ? "none" : null; })
                .style("fill",  d => { 
                    return d.value === d3.max(dataset,  d => { return d.value; }) 
                    ? highlightColor : barColor
                    })
                .attr("x",  d => { return x(d.level_2); })
                .attr("width", x.bandwidth())
                .attr("y",  d => { return height; })
                .attr("height", 0)
                    .transition()
                    .duration(750)
                    .delay(function (d, i) {
                        return i * 150;
                    })
                .attr("y",  d => { return y(d.value); })
                .attr("height",  d => { return height - y(d.value); });

        });
    </script>

</html>